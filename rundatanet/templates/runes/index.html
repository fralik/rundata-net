{% load static %}
{% load settings %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rundata-net</title>
    {% get_from_settings 'USE_GA' as use_ga %}
    {% if use_ga %}
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-116856737-2"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-116856737-2');
    </script>
    {% endif %}

    <link href="https://netdna.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'runes/jstree/themes/default/style.min.css' %}" />

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css"
     integrity="sha512-Rksm5RenBEKSKFjgI3a41vrjkw4EVPlJ3+OiI65vTjIdo9brlAacEuKOiQ5OFh7cOI1bkDwLqdLw3Zg0cRJAAQ=="
     crossorigin=""/>
    <link rel="stylesheet" href="{% static 'runes/css/simplePagination.css' %}" />
    <link rel="stylesheet" href="{% static 'runes/pixabay/jquery.auto-complete.css' %}" />

    <link rel="apple-touch-icon" sizes="180x180" href="{% static 'apple-touch-icon.png' %}">
    <link rel="icon" type="image/png" sizes="32x32" href="{% static 'favicon-32x32.png' %}">
    <link rel="icon" type="image/png" sizes="16x16" href="{% static 'favicon-16x16.png' %}">
    <link rel="mask-icon" href="{% static 'safari-pinned-tab.svg' %}" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#2b5797">
    <meta name="theme-color" content="#ffffff">

    <style type="text/css">
        .my-fixed-height {
          max-height: 500px;
          min-height: 500px;
          height: 500px;
        }
        .myscrollable {
          overflow-y: scroll;
          max-height: 90%;
          height: 90%;
        }
        .vert-small {
          height: 8%;
          border: 0px solid green;
        }
        .border-1 {
          border: 1px solid #ccc;
        }
        .group-full-heigth {
          max-height: 100%;
          min-height: 100%;
          height: 100%;
        }
        .border-left-bottom {
          border-left: 1px solid #ccc;
          border-bottom: 1px solid #ccc;
        }
        .border-bottom-right {
          border-right: 1px solid #ccc;
          border-bottom: 1px solid #ccc;
        }
        body {
          font-family: 'Lucida Grande', 'Lucida Sans Unicode', 'Lucida Sans', 'DejaVu Sans', Verdana, Helvetica, sans-serif;
        }
        .transliteration {
          font-weight: bold;
        }

        .normalization {
          font-style: italic;
          font-weight: normal;
        }

        th {
          text-align: center;
        }
        span.null {
          font-weight: bold;
          color: #CCCCCC;
        }

        .white-text {
          color:#fff!important;
        }
/*        #loading-image {
          position: absolute;
          top: 100px;
          left: 240px;
          z-index: 100;
        }
*/
      .navbar-static-top {
        margin-bottom: 0px;
      }

      .vertical-align {
        display: flex;
        align-items: center;
      }
    </style>
  </head>
<body style="">
  <nav class="navbar navbar-default navbar-static-top">
    <div class="container">
      <div class="navbar-header">
        <a class="navbar-brand" href="#">Rundata-net</a>
      </div>
      <ul class="nav navbar-nav navbar-right">
        <li class=""><a href="{% url 'runes:about' %}" target="_blank">About</a></li>
        <li class=""><a href="http://rundata-net.rtfd.io/" target="_blank">Help</a></li>
      </ul>
    </div>
  </nav>

  <div class="container-fluid">
    <div class="row">
      <div class="col alert alert-danger hidden" role="alert" id="alertObj"></div>
    </div>

    <div class="row">
      <div id="leftPanel" class="col-md-3 col-sm-3 panel panel-default my-fixed-height" style="padding-right: 0; padding-left: 0; border-width: 0;">
        <div class="list-group group-full-heigth" style="padding-left: 0px; padding-right: 2px; position: relative;">
          <div id="jstree" class="myscrollable border-bottom-right"></div>
          <div id="lblNumAvailable" class="" style="padding-left: 15px;">Info</div>
          <div id="jstree-nav" class="" style="padding-top: 0.5em; position: absolute; bottom: 0; padding-left: 15px;"></div>
        </div>
      </div>
      <div id="mainDisplay" contentEditable="true" class="col-md-5 col-sm-7 table-bordered my-fixed-height pre-scrollable"></div>
      <div id="mapDisplay" class="col-md-4 col-sm-2 my-fixed-height"></div>
    </div>

    <form class="row pl-4" role="group">
      <div class="checkbox col-md-2">
        <input type="checkbox" id="chkApplyFilters">
        <label for="chkApplyFilters">Apply filter(s)</label>
      </div>
      <div class="col-md-10 btn-group" role="group" aria-label="">
        <button type="button" class="btn btn-default" id="btnDisplayFormat">Show display format dialog</button>
        <button type="button" class="btn btn-default" id="btnShowMap">Hide map</button>
      </div>
    </form>

    <section role="group" class="row vertical-align">
      <div class="col-md-3">Quickly copy symbols to clipboard:</div>
      <div class="col-md-9 btn-group" role="group">
        <button type="button" class="btn clip" id="btnOUmlautSmall">ö</button>
        <button type="button" class="btn clip" id="btnOUmlaut">Ö</button>
        <button type="button" class="btn clip" id="btnAaSmall">å</button>
        <button type="button" class="btn clip" id="btnAa">Å</button>
        <button type="button" class="btn clip" id="btnAaUmlautSmall">ä</button>
        <button type="button" class="btn clip" id="btnAaUmlaut">Ä</button>
        <button type="button" class="btn clip" id="btnDot">•</button>
        <button type="button" class="btn clip" id="btnX">×</button>
        <button type="button" class="btn clip" id="btnTh">þ</button>
        <button type="button" class="btn clip" id="btnEn">ñ</button>
        <button type="button" class="btn clip" id="btnDh">ð</button>
        <button type="button" class="btn clip" id="btnAe">æ</button>
        <button type="button" class="btn clip" id="btnOe">ø</button>
        <button type="button" class="btn clip" id="btnCross">†</button>
        <button type="button" class="btn clip" id="btnOe2">œ</button>
        <button type="button" class="btn clip" id="btnOhakeSmall">ô</button>
        <button type="button" class="btn clip" id="btnOhakeCapital">Ô</button>
        <button type="button" class="btn clip" id="btnRuneR">ᛦ</button>
      </div>
    </section>
    <section role="group" class="row"><div class="col">&nbsp;</div></section>

    <div id="divFormatDiaglog" class="row border-1">
      <div class="col-sm-5">
        <select name="from[]" id="multiselect" class="form-control" size="8" multiple="multiple"></select>
        <div class="row">
          <form role="form" class="col-sm-6">
            <div class="checkbox">
              <input type="checkbox" id="chkDisplayHeaders" checked>
              <label for="chkDisplayHeaders">Display headers</label>
            </div>
          </form>
        </div>
      </div>

      <div class="col-sm-2">
        <button type="button" id="multiselect_rightAll" class="btn btn-block"><i class="glyphicon glyphicon-forward"></i></button>
        <button type="button" id="multiselect_rightSelected" class="btn btn-block"><i class="glyphicon glyphicon-chevron-right"></i></button>
        <button type="button" id="multiselect_leftSelected" class="btn btn-block"><i class="glyphicon glyphicon-chevron-left"></i></button>
        <button type="button" id="multiselect_leftAll" class="btn btn-block"><i class="glyphicon glyphicon-backward"></i></button>
      </div>

      <div class="col-sm-5">
        <select name="to[]" id="multiselect_to" class="form-control" size="8" multiple="multiple"></select>
        <div class="row">
          <div class="col-sm-6">
            <button type="button" id="multiselect_move_up" class="btn btn-block"><i class="glyphicon glyphicon-arrow-up"></i></button>
          </div>
          <div class="col-sm-6">
            <button type="button" id="multiselect_move_down" class="btn btn-block"><i class="glyphicon glyphicon-arrow-down"></i></button>
          </div>
        </div>
      </div>
    </div>

    <div class="row">
      <div id="builder" class="col"></div>
    </div>

  </div>

  <aside id="loading" class="loading-screen" style="position:fixed; top:0; right:0; bottom:0; left:0; z-index:9999; background-color: #000; opacity: 0.6;">
    <div class="col-sm-8 col-sm-offset-2 col-md-6 col-md-offset-3 col-lg-4 col-lg-offset-4" style="position:absolute; top:50%; margin-top:-7em">
      <div class="page-header">
        <i class="text-primary fa fa-spin fa-fw pull-left fa-spinner fa-2x" style="text-shadow: 0px 0px 0ex;"></i>
        <hgroup class="" style="text-shadow: 0px 0px 0ex;">
          <h4 ng-switch-default="" class="white-text">
            Loading<br>
            <small class="white-text">It can take up to 45 seconds.</small>
          </h4>
        </hgroup>
      </div>
    </div>
  </aside>

<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
<!-- query builder styles -->
<link href="{% static 'query-builder/bootstrap-datepicker3.min.css' %}" rel="stylesheet">
<link href="{% static 'query-builder/bootstrap-slider.min.css' %}" rel="stylesheet">
<link href="{% static 'query-builder/selectize.bootstrap3.css' %}" rel="stylesheet">
<link href="{% static 'query-builder/bootstrap-select.min.css' %}" rel="stylesheet">
<!-- <link href="https://querybuilder.js.org/dist/awesome-bootstrap-checkbox/awesome-bootstrap-checkbox.css" rel="stylesheet"> -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/awesome-bootstrap-checkbox/0.3.7/awesome-bootstrap-checkbox.css" rel="stylesheet">
<link href="{% static 'query-builder/query-builder.default.min.css' %}" rel="stylesheet">
<!--<link href="{% static 'runes/chosen/chosen.min.css' %}" rel="stylesheet">-->
<link href="{% static 'runes/jquery-ui/jquery-ui.min.css' %}" rel="stylesheet">
<!-- end of query builder styles -->

<script src="https://unpkg.com/clipboard@2.0.0/dist/clipboard.min.js"></script>
<script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
<script src="{% static 'runes/jstree/jstree.js' %}"></script>
<script src="https://netdna.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootbox.js/4.3.0/bootbox.min.js"></script>
<script src="{% static 'runes/interact.min.js' %}"></script>
<script src="{% static 'runes/sql.js' %}"></script>

<!-- begin of query builder js -->
<script src="{% static 'query-builder/moment.min.js' %}"></script>
<script src="{% static 'query-builder/bootstrap-datepicker.min.js' %}"></script>
<script src="{% static 'query-builder/bootstrap-slider.min.js' %}"></script>
<script src="{% static 'query-builder/selectize.min.js' %}"></script>
<script src="{% static 'query-builder/bootstrap-select.min.js' %}"></script>
<!--<script src="{% static 'runes/query-builder/query-builder.standalone.js' %}"></script>-->
<script src="{% static 'query-builder/query-builder.standalone.min.js' %}"></script>
<script src="{% static 'query-builder/interact.min.js' %}"></script>
<!--<script type="text/javascript" src="{% static 'runes/chosen/chosen.jquery.min.js' %}"></script>-->
<script type="text/javascript" src="{% static 'runes/jquery-ui/jquery-ui.min.js' %}"></script>
<!-- end of query builder js -->

<script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js"
 integrity="sha512-/Nsx9X4HebavoBvEBuyp3I7od5tA0UzAxs+j83KgC8PU0kgB4XiK4Lfe4y4cgBtaRJQEIFCW+oC506aPT2L1zw=="
 crossorigin=""></script>
<script src="{% static 'runes/jquery.simplePagination.js' %}"></script>
<script src="{% static 'runes/multiselect.min.js' %}"></script>
<script src="{% static 'runes/pixabay/jquery.auto-complete.min.js' %}"></script>
<!-- <script src='https://npmcdn.com/@turf/turf/turf.min.js'></script> -->

<script type="text/javascript">
// Globals:
// connection to the DB
var db = null;
// original data when no filter is applied.
// Used as cache, so we can skip quering the db again
var originalData = [];
var rootIds = []; // Map of parent/root inscription IDs
var rootsJson = []; // JSON representation for rootIds
var sumRootChildren = 0; // number of all children signatures in current search
var origianlSumRootChildren = 0; // reference of sumRootChildren, similar to originalData.
var treeItemsPerPage = 100; // global variable for jsTree pagination
var curPaginationPage = 1;
var signatureNames = []; // names of all signatures in the DB
var signaturesSelectize = [];
var formatDialog = [];
var userSelectedDisplay = []; // list of user selected fields for display per inscription
var myMap = null; // Global handle to map object
var mapMarkers = {}; // Collection of created map markers. This is used in order to create
  // markers only once.

// defaults. TODO: should be replaced with reading from local storage memory
userSelectedDisplay = ['signature_text', 'found_location'];

function applyPagination() {
  var itemsLength = rootsJson.length;
  $('#jstree-nav').pagination({
      items: itemsLength,
      itemsOnPage: treeItemsPerPage,
      cssStyle: 'compact-theme', // compact-theme, light-theme, dark-theme
      onPageClick: function (pageNum) {
          curPaginationPage = pageNum;
          $('#jstree').jstree(true).refresh();
      },
      useAnchors: false,
      text: '',
  });

  $('#jstree').jstree(true).refresh();

  var total = rootsJson.length + sumRootChildren;
  if (total == 0) {
    $('#lblNumAvailable').html('Sorry, no inscriptions has been found.');
  } else {
    $('#lblNumAvailable').html(`${rootsJson.length} signatures.`);
  }

  $('#mainDisplay').empty();
  for (let key in mapMarkers) {
    if (mapMarkers.hasOwnProperty(key)) {
      mapMarkers[key].remove();
    }
  }
}

function dbToJson(columnNames, values, rootsWithChildren = null) {
  let lostIdx = columnNames.indexOf('lost');
  let newReadingIdx = columnNames.indexOf('new_reading');

  let dbJson = values.map(function(v, i) {
      var hasChildren = false;
      //if (rootsWithChildren !== null && rootsWithChildren.has(v[0])) {
          //hasChildren = true;
      //}

      let additional = '';
      if (lostIdx != -1 && newReadingIdx != -1) {
        let isLost = !!+v[lostIdx];
        let isNewReading = !!+v[newReadingIdx];

        if (isLost) {
          additional += "†";
        }
        if (isNewReading) {
          additional += '$';
        }
        if (additional.length > 0)
          additional = ' ' + additional;
      }

      return {
          id: v[0].toString(),
          text: v[1] + additional,
          normalizedText: v[1].normalize('NFD').replace(/[\u0300-\u036f]/g, ""),
          icon: false,
          children: hasChildren,
          id_numeric: v[0],
      }
  });

  return dbJson;
}

function onDisplayFormatClicked() {
  var selectedValues = [];
  if (formatDialog.is(':visible')) {
    $('#multiselect_to option').each(function() { selectedValues.push($(this).val()); });
    if (selectedValues === null || selectedValues.length == 0) {
      $('#alertObj').html('Nothing is selected on format dialog! Please select at least one field.');
      $('#alertObj').removeClass('hidden');
      $('#alertObj').addClass('show');
      return;
    }
  }

  if ($('#alertObj').hasClass('show')) {
    $('#alertObj').removeClass('show');
    $('#alertObj').addClass('hidden');
  }

  if (selectedValues.length > 0) {
    userSelectedDisplay = selectedValues;
    displaySignatureInfo();
  }

  formatDialog.toggle();
  if (formatDialog.is(':visible')) {
    $('#btnDisplayFormat').html('Hide display format dialog');
  } else {
    $('#btnDisplayFormat').html('Show display format dialog');
  }
}

function onShowMapClicked() {
  $('#mapDisplay').toggle();
  if ($('#mapDisplay').is(':visible')) {
    $('#btnShowMap').html('Hide map');
    $('#mainDisplay').removeClass('col-md-9');
    $('#mainDisplay').addClass('col-md-5');
  } else {
    $('#btnShowMap').html('Show map');
    $('#mainDisplay').removeClass('col-md-5');
    $('#mainDisplay').addClass('col-md-9');
  }
}

function selectizeFilter(fieldId) {
  var str = `SELECT DISTINCT ${fieldId} FROM all_data WHERE ${fieldId} NOT NULL AND ${fieldId} <> '' ORDER BY ${fieldId} COLLATE NOCASE;`;
  var contents = db.exec(str);
  var myOptions = contents[0].values.map(function (v) { return {text: v[0]} });

  return {
    id: fieldId,
    field: fieldId,
    label: humanNameForColumnName(fieldId),
    type: 'string',
    plugin: 'selectize',
    plugin_config: {
      valueField: 'text',
      labelField: 'text',
      searchField: 'text',
      sortField: 'text',
      maxItems: 1,
      plugins: ['restore_on_backspace'],
      valueSetter: function (rule, value) {
        rule.$el.find('.rule-value-container input')[0].selectize.setValue(value);
      },
      options: myOptions,
      create: true,
      createOnBlur: true,
      persist: true,
      dropdownDirection: 'up',
    }
  }
}

/* Dictionary with fields:
  .r => rule id, mandatory
  .l => label, mandatory
  .f => field id, optional. If not provided, .r is used.
  .v => default value, optional. If not provided, set to 0.
*/
function prepareBooleanRule(opt) {
  let fieldId = opt.f || opt.r;
  let defaultValue = opt.v || 0;

  return {
    id: opt.r,
    label: opt.l,
    type: 'boolean',
    field: fieldId,
    input: 'radio',
    values: [
      {0: 'No'},
      {1: 'Yes'}
    ],
    default_value: defaultValue,
    operators: ['equal'],
  };
}

function prepareAutoComplete(fieldId) {
  let contents = [];
  if (fieldId.indexOf('normalisation') != -1) {
    let str = `SELECT DISTINCT search_value FROM ${fieldId}`;
    contents = db.exec(str);
  } else if (fieldId.indexOf('runes_personalname') != -1) {
    let str = `SELECT DISTINCT value FROM ${fieldId}`;
    contents = db.exec(str);
  } else {
    let str = `SELECT DISTINCT ${fieldId} FROM all_data WHERE ${fieldId} NOT NULL AND ${fieldId} <> '' ORDER BY ${fieldId} COLLATE NOCASE;`;
    contents = db.exec(str);
  }

  return {
    id: fieldId,
    label: humanNameForColumnName(fieldId),
    type: 'string',
    plugin: 'autoComplete',
    plugin_config: {
      minChars: 2,
      delay: 100,
      source: function (term, suggest) {
        var matches = [];
        for (i = 0; i < contents[0].values.length; i++) {
          if (contents[0].values[i][0].startsWith(term))
            matches.push(contents[0].values[i][0]);
        }
        suggest(matches);
      }
    },
    size: 70,
    operators: ['equal', 'not_equal', 'begins_with', "not_begins_with", "contains", "not_contains",
      "ends_with", "not_ends_with", "is_empty", 'is_not_empty', 'is_null', 'is_not_null'],
  }
}

function applyFilters() {
  var result = $('#builder').queryBuilder('getSQL', false);
  if (!result || !result.sql.length) {
    return;
  }

  console.log('Got SQL: ' + result.sql);
  var contents = db.exec("SELECT signature_id, signature_text, lost, new_reading FROM all_data WHERE " + result.sql);
  if (contents.length == 0) {
    // no results
    rootsJson = [];
    sumRootChildren = 0;
    return ;
  }

  // hash map of inscription IDs that have children.
  var rootsWithChildren = db.exec("SELECT * FROM signatures_with_children");
  // make a hash map for quick read access
  rootsWithChildren = new Map(rootsWithChildren[0].values.map((v, i) => [v[0], 1]));

  rootsJson = dbToJson(contents[0].columns, contents[0].values, rootsWithChildren);

  //contents = db.exec("SELECT COUNT(id) FROM signatures WHERE parent_id IN (SELECT signatureId FROM all_data WHERE " + result.sql + ")");
  //sumRootChildren = contents[0].values[0][0];
  sumRootChildren = 0;
}


function onDbLoaded(e) {
  if (!this.response) {
    return;
  }

  var uInt8Array = new Uint8Array(this.response);
  db = new SQL.Database(uInt8Array);

  // get all root signatures (that are not aliases)
  var contents = db.exec("SELECT signature_id, signature_text, lost, new_reading FROM all_data");
  var rootsWithChildren = db.exec("SELECT * FROM signatures_with_children");
  // make a hash map for quick read access
  rootsWithChildren = new Map(rootsWithChildren[0].values.map((v, i) => [v[0], 1]));

  rootIds = new Map(contents[0].values.map((v, i) => [v[0], 1]));
  rootsJson = dbToJson(contents[0].columns, contents[0].values, rootsWithChildren);
  //sumRootChildren = db.exec("SELECT COUNT(id) FROM signatures WHERE parent_id IS NOT NULL");
  //sumRootChildren = sumRootChildren[0].values[0][0];
  sumRootChildren = 0;

  originalData = rootsJson;
  origianlSumRootChildren = sumRootChildren

  contents = db.exec("SELECT signature_text FROM signatures");
  signatureNames = contents[0].values.map((v, i) => v[0]);

  contents = db.exec("SELECT id, signature_text FROM signatures");
  signaturesSelectize = dbToJson(contents[0].columns, contents[0].values);

  //applyPagination();
  $('#jstree').jstree(true).refresh();

  contents = db.exec('SELECT meta_id, count(1) AS num FROM crosses GROUP BY meta_id ORDER BY num DESC LIMIT 1');
  var maxCrosses = contents[0].values[0][1];

  contents = db.exec('SELECT DISTINCT id, name from cross_forms ORDER BY name COLLATE NOCASE');
  var allCrossForms = contents[0].values.map((v, i) => ['<option value="'+v[0]+'">'+v[1]+'</option>']);

  contents = db.exec('SELECT DISTINCT id, name from material_types ORDER BY name COLLATE NOCASE');
  var allMaterialTypes = (contents[0].values);
  let materialTypeFilter = {
    id: 'material_type',
    field: 'materialType_id',
    label: 'Material type',
    type: 'string',
    plugin: 'autoComplete',
    plugin_config: {
      minChars: 2,
      delay: 100,
      source: function (term, suggest) {
        var matches = [];
        for (i = 0; i < allMaterialTypes.length; i++) {
          if (allMaterialTypes[i][1].startsWith(term))
            matches.push(allMaterialTypes[i][1]);
        }
        suggest(matches);
      }
    },
    operators: ['equal', 'not_equal', 'begins_with', 'not_begins_with', 'contains', 'not_contains',
      'ends_with', 'not_ends_with', 'is_empty', 'is_not_empty'],
  };

  /////////////////////////////////////
  // Initialzie QueryBuilder
  //////////////////////////////////////
  var queryBuilderFilters = [
    {
      id: 'signature_text',
      field: 'signature_text',
      label: humanNameForColumnName('signature_text'),
      type: 'string',
      plugin: 'autoComplete',
      plugin_config: {
        minChars: 2,
        delay: 50,
        source: function(term, suggest) {
          var matches = [];
          console.log('doing the search of ' + term);
          for (i = 0; i < signaturesSelectize.length; i++) {
            if (signaturesSelectize[i].text.startsWith(term)) {
              matches.push(signaturesSelectize[i].text);
              continue;
            }
            // do not do the search if we got a match already
            if (signaturesSelectize[i].normalizedText.startsWith(term)) {
              matches.push(signaturesSelectize[i].text);
              continue;
            }
          }
          console.log('Found ' + matches.length + ' matches');
          suggest(matches);
        }
      },
      size: 40,
      operators: ['equal', 'not_equal', 'begins_with', "not_begins_with", "contains", "not_contains",
        "ends_with", "not_ends_with"],
    },
    {
      id: 'signature_country',
      field: 'signature_text',
      label: 'Country',
      type: 'string',
      input: 'select',
      multiple: true,
      operators: ['in'],
      plugin: 'selectize',
      plugin_config: {
        plugins: ['remove_button'],
        valueSetter: function (rule, value) {
          console.log('We are in value setter');
          rule.$el.find('.rule-value-container input')[0].selectize.setValue(value);
        },
        // valueGetter: function (rule, value) {
        //   rule.$el.find('.rule-value-container select')
        // },
        options: [{text: 'Öland (Öl)', v: 'Öl'}, {text: 'Östergötland (Ög)', v: 'Ög'}, {text: 'Södermanland (Sö)', v: 'Sö'},
          {text: 'Småland (Sm)'}, {text: 'Västergötland (Vg)', v: 'Vg'}, {text: 'Uppand', v: 'U'},
          {text: 'Västmanland (Vs)', v: 'Vs'}, {text: 'Närke (Nä)', v: 'Nä'}, {text: 'Värmland', v: 'Vr'},
          {text: 'Gästrikland', v: 'Gs'}, {text: 'Hälsingland', v: 'Hs'}, {text: 'Medelpad', v: 'M'},
          {text: 'Ångermanland', v: 'Ån'}, {text: 'Dalarna', v: 'D'}, {text: 'Härjedalen', v: 'Hr'},
          {text: 'Jämtland', v: 'J'}, {text: 'Lappland', v: 'Lp'}, {text: 'Dalsland', v: 'Ds'},
          {text: 'Bohuslän', v: 'Bo'}, {text: 'Gotland', v: 'G'}, {text: 'Sweden other', v: 'SE'},
          {text: 'Denmark', v: 'DR'}, {text: 'Norway', v: 'N'}, {text: 'Faroe Islands', v: 'FR'},
          {text: 'Greenland', v: 'GR'}, {text: 'Iceland', v: 'IS'}, {text: 'Finland', v: 'FI'},
          {text: 'Shetland', v: 'Sh'}, {text: 'Orkney', v: 'Or'}, {text: 'Scotland', v: 'Sc'},
          {text: 'England', v: 'E'}, {text: 'Isle of Man', v: 'IM'}, {text: 'Ireland', v: 'IR'},
          {text: 'France', v: 'F'}, {text: 'Netherlands', v: 'NL'}, {text: 'Germany', v: 'DE'},
          {text: 'Poland', v: 'PL'}, {text: 'Latvia', v: 'LV'}, {text: 'Russia', v: 'RU'},
          {text: 'Ukraine', v: 'UA'}, {text: 'Byzantium', v: 'By'}, {text: 'Italy', v: 'IT'},
          {text: 'Other areas', v: 'X'}],
        valueField: 'v',
        labelField: 'text',
        searchField: 'text',
        sortField: 'text',
        create: false,
        dropdownDirection: 'up',
        maxItems: null,
      },
    },
    prepareAutoComplete('found_location'),
    prepareAutoComplete('parish'),
    prepareAutoComplete('district'),
    prepareAutoComplete('municipality'),
    prepareAutoComplete('current_location'),
    prepareAutoComplete('original_site'),
    prepareAutoComplete('rune_type'),
    prepareAutoComplete('dating'),
    prepareAutoComplete('carver'),
    prepareAutoComplete('material'),
    prepareAutoComplete('normalisation_norse'),
    prepareAutoComplete('normalisation_scandinavian'),
    prepareAutoComplete('english_translation'),
    prepareAutoComplete('transliteration'),
    prepareAutoComplete('style'),
    prepareAutoComplete('reference'),
    prepareAutoComplete('additional'),
    prepareAutoComplete('objectInfo'),
    prepareAutoComplete('runes_personalname'),
    prepareBooleanRule({'r':'has_personal_name', 'l':'Has personal name?', 'f':'num_names', 'v':1}),
    prepareBooleanRule({'r':'alternatives', 'l':'Has alternative(s)?', 'f':'signatures.id', 'v':1}),
    prepareBooleanRule({'r':'lost', 'l':'Is lost?'}),
    prepareBooleanRule({'r':'new_reading', 'l':'New reading?'}),
    {
      id: 'num_crosses',
      label: 'Number of crosses',
      type: 'integer',
      input: 'number',
      validation: {
        min: 0,
        max: maxCrosses,
        step: 1,
        allow_empty_value: false,
      },
      default_value: 0,
      operators: ['equal', 'not_equal', 'less', 'less_or_equal', 'greater', 'greater_or_equal',
        'between', 'not_between'],
      size: 10,
    },
    {
      id: 'cross_form',
      label: 'Cross form',
      type: 'string',
      operators: ['cross_form'],
      input: function (rule, name) {
        //let $container = rule.$el.find('.rule-value-container');
        return '\
          <select name="'+name+'_1">\
          ' + allCrossForms +
          '</select>\
          <div>Certain?\
            <label><input type="radio" name="'+name+'_2" value="0">No</label>\
            <label><input type="radio" name="'+name+'_2" value="1" checked>Yes</label>\
          </div>';
      },
      valueGetter: function (rule) {
        let val1 = rule.$el.find('.rule-value-container [name$=_1]').val();
        let val2 = rule.$el.find('.rule-value-container [name$=_2]:checked').val();
        return {form: val1, is_certain: val2};
      }
    },
    materialTypeFilter,
    prepareBooleanRule({'r':'ornamental', 'l':'Is pure ornamental?', 'v': 1}),
  ];

  // Fix for Selectize
  $('#builder').on('afterCreateRuleInput.queryBuilder', function(e, rule) {
    if (rule.filter.plugin == 'selectize') {
      rule.$el.find('.rule-value-container').css('min-width', '200px')
        .find('.selectize-control').removeClass('form-control');
    }
  });

  $('#builder').queryBuilder({
    operators: $.fn.queryBuilder.constructor.DEFAULTS.operators.concat([
      { type: 'alternatives_in',  nb_inputs: 1, multiple: false, apply_to: ['string'] },
      { type: 'cross_form', nb_inputs: 1, multiple: false, apply_to: ['string'] },
    ]),

    lang: {
      operators: {
        alternatives_in: ' ',
        cross_form: ' ',
      }
    },

    // SQL export (first half)
    sqlOperators: {
      alternatives_in: { op: 'IN' },
      cross_form: { op: 'IN' },
    },
    plugins: {
      'bt-tooltip-errors': null,
      'sortable': null,
      'not-group': null,
      'bt-selectpicker': {liveSearch: true, liveSearchStyle: 'startsWith'},
    },

    filters: queryBuilderFilters,
    sort_filters: true,
  })
  .on('rulesChanged.queryBuilder', function () {
      if ($('#chkApplyFilters').is(":checked")) {
          console.log('Rules changed and filter is checked')
          applyFilters();
          applyPagination();
      }
  })
  // SQL export (second half)
  .on('ruleToSQL.queryBuilder.filter', function (e, rule, sqlValue, sqlOperator) {
    if (rule.operator === 'alternatives_in') {
      if (rule.value == 1) {
        e.value = rule.field + ' ' + sqlOperator() + ' signatures_with_children';
      } else {
        e.value = rule.field + ' IN root_signatures and ' + rule.field +
          ' NOT ' + sqlOperator() + ' signatures_with_children';
      }
      console.log(e.value);
    }
    if (rule.operator === 'cross_form') {
      e.value = 'id IN (SELECT meta_id FROM crosses WHERE crosses.id in (SELECT cross_id FROM cross_definitions WHERE form_id="' + rule.value[0].form + '" AND is_certain="' + rule.value[0].is_certain + '"))';
    }
    if (rule.id === 'material_type') {
      e.value = rule.field + ' IN (SELECT id FROM material_types WHERE name ' + sqlOperator(sqlValue) + ')';
      console.log(e.value);
    }
    if (rule.id === 'signature_country') {
      e.value = "(" + rule.value.map(function (v, i) { return rule.field + " LIKE ('"+v+"%')"; }).join(' OR ') + ")";
    }
    if (rule.id === 'has_personal_name') {
      if (rule.value == 1) {
        e.value = rule.field + '> 0';
      } else {
        e.value = rule.field + '= 0';
      }
    }
  })
  ;

  if (!window.Selectize.prototype.positionDropdownOriginal) {
    window.Selectize.prototype.positionDropdownOriginal = window.Selectize.prototype.positionDropdown;
    window.Selectize.prototype.positionDropdown = function () {
      this.settings.dropdownDirection = 'up';
      if (this.settings.dropdownDirection === 'up') {
        let $control = this.$control;
        let offset = this.settings.dropdownParent === 'body' ? $control.offset() : $control.position();

        this.$dropdown.css({
          width: $control.outerWidth(),
          top: offset.top - this.$dropdown.outerHeight(),
          left: offset.left
        });
        this.$dropdown.addClass('direction-' + this.settings.dropdownDirection);
        this.$control.addClass('direction-' + this.settings.dropdownDirection);
        this.$wrapper.addClass('direction-' + this.settings.dropdownDirection);
      } else {
        window.Selectize.prototype.positionDropdownOriginal.apply(this, arguments);
      }
    };
  }

  // button handlers
  $('#btnDisplayFormat').on('click', onDisplayFormatClicked);
  $('#btnShowMap').on('click', onShowMapClicked);

  $('#chkApplyFilters').on('change', function() {
    if (this.checked) {
      applyFilters();
    } else {
      rootsJson = originalData;
      sumRootChildren = origianlSumRootChildren;
    }
    applyPagination();
  });
}

// Data provided for jsTree.
function fetchTreeData(obj, cb) {
  if (obj.id === '#') {
    if (db === null) {
        // we need to load the database first
        return;
    }
    var pageNum = curPaginationPage;
    var perPage = treeItemsPerPage;
    var start = perPage * (pageNum - 1);
    var end = start + perPage;

    // we do not check the boundaries!
    cb.call(this, rootsJson.slice(start, end));
  }/* else {
    var contents = db.exec("SELECT * FROM signatures where parent_id = '" + obj.id + "'");
    var children = dbToJson(contents[0].columns, contents[0].values);
    cb.call(this, children);
  }*/
}

function displaySignatureInfo() {
  $('#mainDisplay').empty();
  for (let key in mapMarkers) {
    if (mapMarkers.hasOwnProperty(key)) {
      mapMarkers[key].remove();
    }
  }

  let indices = $('#jstree').jstree(true).get_selected();
  if (indices.length == 0)
    return;

  let finalText = '';
  let customColumns = ['transliteration', 'english_translation', 'normalisation_scandinavian', 'normalisation_norse'];

  const paragraphSymbol = '§';
  const sidesMarker = '§A';
  const readingMarker = '§P';
  let staticBase = "{% static 'runes/images/cross_forms/' %}";
  const showHeaders = $('#chkDisplayHeaders').is(":checked");

  let markersLatLon = [];

  let properParents = [];
  let jsTreeObj = $('#jstree').jstree(true);
  for (let i = 0; i < indices.length; i++) {
    let row = indices[i];
    let parentId = jsTreeObj.get_parent(row);
    if (parentId !== '#') {
      // if parent is not the tree root node, then the selected node is a child
      row = parentId;
    }
    properParents.push(row);
  }

  let contents = db.exec("SELECT * FROM all_data where signature_id IN (" + properParents.join(',') + ")");
  if (!contents || contents.length == 0)
    return;

  let latIdx = contents[0].columns.indexOf('latitude');
  let lonIdx = contents[0].columns.indexOf('longitude');
  let signNameIdx = 0;
  let metaIdIdx = contents[0].columns.indexOf('id');

  for (let i = 0; i < indices.length; i++) {
    let row = properParents[i];

    if ($('#mapDisplay').is(':visible')) {
      // handle map marker only if map is visible
      let marker = '';
      if (row in mapMarkers) {
        marker = mapMarkers[row];
      } else {
        let lat = parseFloat(contents[0].values[i][latIdx]);
        let lon = parseFloat(contents[0].values[i][lonIdx]);
        if ((!isNaN(lat) && !isNaN(lon)) && (lat != 0 && lon != 0)) {
          console.log('Got lat/lon')
          marker = new L.marker([lat, lon]);
          let popupText = "<b>" + contents[0].values[i][signNameIdx] + "</b>";
          marker.bindPopup(popupText);
          mapMarkers[row] = marker;
        }
      }
      if (marker instanceof Object) {
        marker.addTo(myMap);
        markersLatLon.push(marker.getLatLng());
      }
    }

    let paragraph = '';
    for (let j = 0; j < userSelectedDisplay.length; j++) {
      let humanName = humanNameForColumnName(userSelectedDisplay[j]);
      if (showHeaders) {
        paragraph += '<h4>' + humanName + '</h4>';
      } else if (paragraph.length > 0) {
        paragraph += '<br>';
      }

      if (userSelectedDisplay[j] == 'images') {
        let directImages = db.exec("SELECT id, link_url, direct_url FROM runes_imagelink WHERE meta_id = '" + contents[0].values[i][metaIdIdx] + "' AND direct_url <> '' LIMIT 9");
        let dbImages = [];
        if (directImages.length > 0) {
          let ids = directImages[0].values.map(function (v, i) { return v[0]; });
          ids = ids.join(',');
          dbImages = db.exec("SELECT link_url, direct_url FROM runes_imagelink WHERE meta_id = '" + contents[0].values[i][metaIdIdx] + "' AND id NOT IN (" + ids + ")");
        } else {
          dbImages = db.exec("SELECT link_url, direct_url FROM runes_imagelink WHERE meta_id = '" + contents[0].values[i][metaIdIdx] + "'");
        }
        let indirectImages = 'No images.';
        if (dbImages.length > 0) {
          indirectImages = '<ul>';
          dbImages[0].values.map(function (v, i) {
            indirectImages += `<li><a href="${v[0]}" contentEditable="false">${v[0]}</a></li>`;
          });
          indirectImages += '</ul>';
        }

        if (directImages.length == 0) {
          paragraph += indirectImages;
          continue;
        }

        paragraph += '<div class="container-fluid"><div class="row">';
        directImages[0].values.map(function (v, i) {
          if (i % 3 == 0) {
            paragraph += "</div>";
            if (i < 9)
              paragraph += '<div class="row">';
          }
          paragraph += `<div class="col-md-4"><a href="${v[1]}" contentEditable="false" target="_blank"><img src="${v[2]}" class="img-responsive"></a></div>`;
        });
        paragraph += '</div>';

        if (indirectImages !== 'No images.') {
          paragraph += '<br>' + indirectImages;
        }

        continue;
      }

      let columnIdx = contents[0].columns.indexOf(userSelectedDisplay[j]);
      let columnData = contents[0].values[i][columnIdx];

      if (jQuery.inArray(userSelectedDisplay[j], customColumns) != -1) {
        let cssStyle = 'normalization';
        if (~userSelectedDisplay[j].indexOf('transliteration')) {
          cssStyle = 'transliteration';
        } else if (~userSelectedDisplay[j].indexOf('english_translation')) {
          cssStyle = '';
        }

        if (~columnData.indexOf(paragraphSymbol)) {
          let parts = columnData.split(paragraphSymbol);
          let listHeader = '';
          if (~columnData.indexOf(sidesMarker)) {
            listHeader = 'Sides:';
          } else if (~columnData.indexOf(readingMarker)) {
            listHeader = 'Reading variants:';
          }

          paragraph += listHeader;
          paragraph += '<ol type="A">';
          for (let k = 0; k < parts.length; k++) {
            let part = parts[k];
            let partData = '';

            if (!part.trim())
              continue;

            if (part.length > 2)
              partData = part.substr(2);

            paragraph += '<li><span class="' + cssStyle + '">' + partData + '</span></li>';
          }
          paragraph += '</ol>';
        } else {
          // no parts in the columnData
          paragraph += '<span class="' + cssStyle + '">' + columnData + '</span>';
        }
        continue;
      }

      if (userSelectedDisplay[j] === 'crosses') {
        let numCrossesColumnIdx = contents[0].columns.indexOf('num_crosses');
        let numCrosses = contents[0].values[i][numCrossesColumnIdx];
        if (numCrosses == 0) {
          paragraph += 'No crosses';
          continue;
        }

        paragraph += '<table class="crosses" border="1">';
        paragraph += '<thead><tr>';
        paragraph += '<th>A</th>';
        paragraph += '<th>B</th>';
        paragraph += '<th>C</th>';
        paragraph += '<th>D</th>';
        paragraph += '<th>E</th>';
        paragraph += '<th>F</th>';
        paragraph += '<th>G</th>';
        paragraph += '</th></thead>';
        paragraph += '<tbody>';

        let allCrosses = crossesForMeta(contents[0].values[i][metaIdIdx]);
        for (let k = 0; k < allCrosses.length; k++) {
          if (allCrosses[k][0].length > 0) {
            // this is a cross from undefined group
            paragraph += '<tr><td colspan="7">' + allCrosses[k][0][0].name + '</td></tr>';
            continue;
          }
          paragraph += '<tr>';
          // we have 8 groups in total, 0 being free-text and not a real group
          for (let gr = 1; gr < 8; gr++) {
            let crossForms = allCrosses[k][gr];
            if (crossForms.length == 0) {
              paragraph += '<td><span class="null">&#8709;</span></td>';
              continue;
            }
            paragraph += '<td>';
            paragraph += allCrosses[k][gr].map(function (v, i) {
              let url = staticBase + v.name + '.png';
              let res = '<img src="' + url + '" alt="'+v.name+'" title="'+v.name+'" width="32" height="32">';
              if (v.isCerain == 0) {
                res += '?';
              }
              return res;
            }).join(', ');
            paragraph += '</td>';
          }
        }
        paragraph += '</tbody></table>';
        continue;
      }

      paragraph += columnData;
    }

    finalText += '<p>' + paragraph + '</p>';
  }

  $('#mainDisplay').html(finalText);
  if (markersLatLon.length > 0) {
    console.log('Got some markers');
    let markersBounds = L.latLngBounds(markersLatLon);
    myMap.fitBounds(markersBounds);
  }
}

/* Find all crosses related to particular metaId.
 * Returned variable is a multidimensional array. Dimensions:
 * 1. First dimension contains individual crosses.
 * 2. Second dimension denotes cross form group. There could only be 8 groups.
 * 3. Third dimension contains objects with 2 data fields (name, isCertain). Each object represents a particular cross form in a group.
 *    Note that some groups can be empty.
 */
function crossesForMeta(metaId) {
  // we do not check that this meta contains any crosses. This should be done in parent call
  let cc = db.exec("SELECT id FROM crosses WHERE meta_id = '" + metaId + "'");
  let contents = db.exec("SELECT cross_id, cross_forms.id, cross_forms.name, cross_forms.group_id, cross_definitions.is_certain FROM cross_definitions INNER JOIN cross_forms ON (cross_definitions.form_id = cross_forms.id) WHERE cross_id IN (SELECT id FROM crosses WHERE meta_id = '" + metaId + "') ORDER BY cross_id");

  let lastCrossId = -1;
  let crosses = [];

  for (let i = 0; i < contents[0].values.length; i++) {
    let crossId = parseInt(contents[0].values[i][0], 10);
    if (crossId != lastCrossId) {
      lastCrossId = crossId;
      crosses.push(Array.apply(null, Array(8)).map(function() {return [];}));
    }

    let formName = contents[0].values[i][2];
    let groupId = contents[0].values[i][3];
    let isCertain = contents[0].values[i][4];

    crosses[crosses.length - 1][parseInt(groupId, 10)].push({name: formName, isCertain: isCertain});
  }
  return crosses;
}

function displayFields() {
  let displayOptions = [
    {
      value: 'signature_text',
      text: 'Signature'
    },
    {
      value: 'found_location',
      text: 'Found location'
    },
    {
      value: 'parish',
      text: 'Parish'
    },
    {
      value: 'district',
      text: 'District'
    },
    {
      value: 'municipality',
      text: 'Municipality'
    },
    {
      value: 'current_location',
      text: 'Current location'
    },
    {
      value: 'original_site',
      text: 'Original site'
    },
    {
      value: 'parish_code',
      text: 'Parish code'
    },
    {
      value: 'rune_type',
      text: 'Rune type'
    },
    {
      value: 'dating',
      text: 'Dating'
    },
    {
      value: 'style',
      text: 'Style'
    },
    {
      value: 'carver',
      text: 'Carver'
    },
    {
      value: 'material',
      text: 'Material'
    },
    {
      value: 'materialType_id',
      text: 'Material type'
    },
    {
      value: 'objectInfo',
      text: 'Object information'
    },
    {
      value: 'reference',
      text: 'References'
    },
    {
      value: 'additional',
      text: 'Other information'
    },
    {
      value: 'normalisation_norse',
      text: 'Normalization to Old West Norse'
    },
    {
      value: 'normalisation_scandinavian',
      text: 'Normalisation to Old Scandinavian'
    },
    {
      value: 'english_translation',
      text: 'Translation to English'
    },
    {
      value: 'transliteration',
      text: 'Transliterated runic text'
    },
    {
      value: 'num_crosses',
      text: 'Number of crosses'
    },
    {
      value: 'crosses',
      text: 'Cross form'
    },
    {
      value: 'images',
      text: 'Images'
    },
    {
      value: 'reference',
      text: 'References'
    },
  ];
  return displayOptions;
}

function humanNames() {
  let namesMap = [
    {
      value: 'runes_personalname',
      text: 'Personal Name'
    },
  ];
  return namesMap;
}

function humanNameForColumnName(columnName) {
  let a = displayFields().find(x => x.value === columnName);
  if (a) {
    return a.text;
  }
  a = humanNames().find(x => x.value === columnName);
  if (a) {
    return a.text;
  }
  return "Undefined";
  //return displayFields().find(x => x.value === columnName).text;
}

function initMultiselect() {
  var displayOptions = displayFields();

  $.each(displayOptions, function (i, item) {
      if (jQuery.inArray(item.value, userSelectedDisplay) != -1) {
        $('#multiselect_to').append($('<option>', {
            value: item.value,
            text : item.text
        }));
        return;
      }
      $('#multiselect').append($('<option>', {
          value: item.value,
          text : item.text
      }));
  });

  $('#multiselect').multiselect({
    keepRenderingSort: true,
  });
  formatDialog = $('#divFormatDiaglog');
}

function setTooltip(btn, message) {
  let that = $(btn);
  that.attr('data-original-title', message).tooltip('show');
  // do not care about multiple calls to setTimeout
  setTimeout(function() {
    that.tooltip('hide');
  }, 500);
}

var clipboard = [];
$(function() {
  var xhr = new XMLHttpRequest();
  xhr.open('GET', "{% static 'runes/runes.sqlite3' %}", true);
  xhr.responseType = 'arraybuffer';
  xhr.addEventListener("load", onDbLoaded);
  xhr.send();

  initMultiselect();
  formatDialog.hide();
  $('#alertObj').hide();

  $('.clip').each(function (i) {
    // prepare buttons for clipboard library
    $(this).attr('data-clipboard-text', $(this).html());
  });
  $('.clip').tooltip({
    container: 'body',
    placement: 'bottom',
    title: 'Copied123!',
    trigger: 'manual',
    delay: 10,
  });
  clipboard = new ClipboardJS('.btn');
  clipboard.on('success', function(e) {
    setTooltip(e.trigger, 'Copied!');
  });
  clipboard.on('error', function(e) {
    setTooltip(e.trigger, 'Failed!');
  });

  // customMarker = L.Marker.extend({
  //    options: {
  //       myId: -1,
  //    }
  // });
  myMap = L.map('mapDisplay').setView([57.481491, 18.485840], 8);
  let osmAttrib = 'Map data © <a href="https://openstreetmap.org">OpenStreetMap</a> contributors';
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
    {
      minZoom: 1,
      maxZoom: 15,
      attribution: osmAttrib
    }
  ).addTo(myMap);

  // Next phase, jstree creation/initialization
  $('#jstree')
  .on('ready.jstree', function () {
      $('#loading').hide();
      applyPagination();
  })
  .on('changed.jstree', function(node, eventObj) {
    if (eventObj.action == 'select_node') {
      displaySignatureInfo();
    }
  })
  .jstree({
      'core': {
          'animation': 0,
          'data': fetchTreeData,
      }
  });
});

// 45 sec timeout
setTimeout(function() {
  if ($('#loading').is(':visible')) {
    $(document.body).html("Seems that something went wrong and the app is not usable. Try to refresh the page or come later.");
    alert('Seems that something went wrong and the app is not usable. Try to refresh the page or come later.');
  }
}, 45000);
</script>

</body>
</html>
