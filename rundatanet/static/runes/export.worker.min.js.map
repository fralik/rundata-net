{"version":3,"file":"export.worker.min.js","sources":["../../runes/js/export.worker.js"],"sourcesContent":["/**\n * Web Worker for exporting inscription data to Excel format\n * \n * Input: e.data is a dictionary with fields:\n *   inscriptions - Array of inscription objects from gViewModel.getActiveInscriptions()\n *   columns - Object mapping column names to human-readable names\n *   rules - Optional. Search parameters to include in a separate sheet\n *\n * Creates and downloads an XLSX file\n */\n\n// Import the XLSX library\nimportScripts('https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js');\n\nonmessage = function(e) {\n  try {\n    const inscriptions = e.data.inscriptions;\n    const columnMap = e.data.columnMap;\n    const rules = e.data.rules; // Optional search parameters\n\n    // Extract column names and human names from the column map\n    const columns = Object.keys(columnMap);\n    const humanNames = columns.map(col => columnMap[col]);\n    \n    // Process the data and generate Excel data\n    const processedData = processDataForExcel(inscriptions, columns);\n    \n    // Create workbook and main worksheet\n    const workbook = XLSX.utils.book_new();\n    const worksheet = XLSX.utils.aoa_to_sheet([\n      humanNames, // Header row with human-readable column names\n      ...processedData\n    ]);\n    \n    // Add the main data worksheet\n    XLSX.utils.book_append_sheet(workbook, worksheet, 'Results');\n    \n    // If search rules are provided, add them to a separate sheet\n    if (rules && !isEmpty(rules)) {\n      const rulesSheet = createRulesWorksheet(rules);\n      XLSX.utils.book_append_sheet(workbook, rulesSheet, 'Search Parameters');\n    }\n    \n    // Generate the XLSX file as an ArrayBuffer\n    const excelBuffer = XLSX.write(workbook, { type: 'array', bookType: 'xlsx' });\n    \n    // Send the processed data back to the main thread\n    postMessage({\n      buffer: excelBuffer,\n      success: true\n    });\n  } catch (error) {\n    console.error('Error in export worker:', error);\n    postMessage({\n      error: true,\n      message: error.message,\n      stack: error.stack\n    });\n  }\n};\n\n/**\n * Process inscription data for Excel export\n * \n * @param {Array} inscriptions - Array of inscription objects\n * @param {Array} columns - Array of column names to include\n * @returns {Array} Array of arrays with processed data\n */\nfunction processDataForExcel(inscriptions, columns) {\n  const result = [];\n\n  for (let i = 0; i < inscriptions.length; i++) {\n    const rowData = [];\n    const inscription = inscriptions[i];\n\n    if (!inscription) {\n      console.error(`No data found for inscription at index: ${i}`);\n      continue;\n    }\n\n    for (let j = 0; j < columns.length; j++) {\n      const columnName = columns[j];\n      let colData = inscription[columnName];\n\n      // Special handling for null values\n      if (colData === null || colData === undefined) {\n        colData = '';\n      }\n\n      // Special handling for signature_text\n      if (columnName === 'signature_text' && inscription.hasOwnProperty('signature_text_raw')) {\n        colData = inscription['signature_text_raw'];\n      }\n\n      // Special handling for crosses\n      if (columnName === 'crosses') {\n        colData = processCrosses(inscription[columnName]);\n      }\n\n      // Convert arrays to strings\n      if (Array.isArray(colData)) {\n        colData = colData.join(';');\n      }\n\n      rowData.push(colData);\n    }\n\n    result.push(rowData);\n  }\n\n  return result;\n}\n\n/**\n * Process cross data for Excel format\n * \n * @param {Array} crosses - Array of cross data\n * @returns {String} Formatted cross data as string\n */\nfunction processCrosses(crosses) {\n  if (!crosses || crosses.length === 0) {\n    return '';\n  }\n\n  const crossData = [];\n\n  for (let cId = 0; cId < crosses.length; cId++) {\n    const crossObj = crosses[cId];\n    const oneCross = [];\n\n    if (crossObj[0] && crossObj[0].length > 0) {\n      // This cross has something in group 0, so it must not contain anything in other groups\n      crossData.push(crossObj[0][0].name);\n      continue;\n    }\n\n    // Process each group\n    for (let gId = 1; gId < crossObj.length; gId++) {\n      const groupItems = crossObj[gId];\n      \n      if (!groupItems || groupItems.length === 0) {\n        oneCross.push('');\n        continue;\n      }\n\n      const oneGroup = [];\n      for (let fId = 0; fId < groupItems.length; fId++) {\n        const crossForm = groupItems[fId];\n        if (crossForm.isCertain) {\n          oneGroup.push(crossForm.name);\n        } else {\n          oneGroup.push(`${crossForm.name} ?`);\n        }\n      }\n      \n      oneCross.push(oneGroup.join(',')); // Join individual cross forms with comma\n    }\n    \n    crossData.push(oneCross.join(';')); // Join groups with semicolon\n  }\n\n  return crossData.join(' & '); // Join crosses with ampersand\n}\n\n/**\n * Create a worksheet for search rules\n * \n * @param {Object} rules - Query builder rules object\n * @returns {Object} XLSX worksheet\n */\nfunction createRulesWorksheet(rules) {\n  // Convert the rules object to a readable format\n  const rulesData = [];\n  const rulesString = JSON.stringify(rules, null, 2);\n\n  // Add title row\n  rulesData.push(['Search Parameters']);\n  rulesData.push(['Generated on', new Date().toLocaleString()]);\n  rulesData.push(['']); // Empty row for spacing\n  rulesData.push([rulesString]);\n  \n  return XLSX.utils.aoa_to_sheet(rulesData);\n}\n\n/**\n * Check if an object is empty\n * \n * @param {Object} obj - Object to check\n * @returns {boolean} True if object is empty, false otherwise\n */\nfunction isEmpty(obj) {\n  return Object.keys(obj).length === 0;\n}"],"names":["processCrosses","crosses","length","crossData","cId","crossObj","oneCross","push","name","gId","groupItems","oneGroup","fId","crossForm","isCertain","join","importScripts","onmessage","e","inscriptions","data","columnMap","rules","columns","Object","keys","humanNames","map","col","processedData","result","i","rowData","inscription","j","columnName","colData","hasOwnProperty","Array","isArray","console","error","processDataForExcel","workbook","XLSX","utils","book_new","worksheet","aoa_to_sheet","book_append_sheet","obj","rulesSheet","rulesData","rulesString","JSON","stringify","Date","toLocaleString","createRulesWorksheet","excelBuffer","write","type","bookType","postMessage","buffer","success","message","stack"],"mappings":"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"}